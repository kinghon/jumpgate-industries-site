<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade Analyzer ‚Äî Fair or Fleeced?</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Inter',-apple-system,sans-serif;background:#0a0a0f;color:#e4e4e7;min-height:100vh;padding:1.5rem 1rem}
  .container{max-width:1200px;margin:0 auto}
  header{text-align:center;margin-bottom:2rem}
  header h1{font-size:2rem;font-weight:900;margin-bottom:.3rem}
  header p{color:#71717a;font-size:.85rem}
  a.back{color:#3b82f6;font-size:.8rem;text-decoration:none;display:inline-block;margin-bottom:1rem}

  /* Trade layout */
  .trade-area{display:grid;grid-template-columns:1fr auto 1fr;gap:1rem;margin-bottom:1.5rem;align-items:start}
  @media(max-width:900px){.trade-area{grid-template-columns:1fr;}.vs-divider{transform:none!important}}

  .side{background:#18181b;border:1px solid #27272a;border-radius:14px;padding:1.25rem;min-height:400px}
  .side-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
  .side-title{font-size:1rem;font-weight:800}
  .side-total{font-size:1.1rem;font-weight:800}
  .side-a .side-title{color:#3b82f6}.side-a .side-total{color:#3b82f6}
  .side-b .side-title{color:#f97316}.side-b .side-total{color:#f97316}

  /* Upload zone */
  .upload-zone{border:2px dashed #27272a;border-radius:10px;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:1rem;position:relative;min-height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center}
  .upload-zone:hover{border-color:#3f3f46;background:rgba(255,255,255,.02)}
  .upload-zone.has-images{padding:.75rem;min-height:auto}
  .upload-zone input{display:none}
  .upload-zone .upload-icon{font-size:2rem;margin-bottom:.5rem}
  .upload-zone .upload-text{font-size:.8rem;color:#71717a}
  .upload-zone .upload-sub{font-size:.65rem;color:#3f3f46;margin-top:.25rem}
  .preview-grid{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center}
  .preview-img{width:80px;height:110px;object-fit:cover;border-radius:6px;border:1px solid #27272a}
  .clear-imgs{font-size:.65rem;color:#ef4444;cursor:pointer;margin-top:.5rem}

  /* Card search */
  .add-card-area{margin-bottom:.75rem}
  .card-search{width:100%;background:#0a0a0f;border:1px solid #27272a;border-radius:8px;padding:.5rem .75rem;color:#e4e4e7;font-size:.8rem;font-family:inherit;outline:none}
  .card-search:focus{border-color:#3f3f46}
  .search-results{background:#18181b;border:1px solid #27272a;border-radius:8px;max-height:200px;overflow-y:auto;margin-top:.25rem;display:none}
  .search-results.open{display:block}
  .sr-item{padding:.5rem .75rem;cursor:pointer;font-size:.75rem;display:flex;justify-content:space-between;align-items:center;transition:background .1s}
  .sr-item:hover{background:#27272a}
  .sr-name{color:#e4e4e7}.sr-price{color:#22c55e;font-weight:700}
  .sr-cat{font-size:.6rem;color:#52525b;margin-left:.3rem}

  /* Custom card input */
  .custom-add{display:flex;gap:.4rem;margin-top:.5rem}
  .custom-add input{flex:1;background:#0a0a0f;border:1px solid #27272a;border-radius:6px;padding:.4rem .6rem;color:#e4e4e7;font-size:.75rem;font-family:inherit;outline:none}
  .custom-add input:focus{border-color:#3f3f46}
  .custom-add button{background:#27272a;border:1px solid #3f3f46;border-radius:6px;padding:.4rem .8rem;color:#e4e4e7;font-size:.75rem;cursor:pointer;font-family:inherit;white-space:nowrap}
  .custom-add button:hover{background:#3f3f46}
  .or-divider{text-align:center;font-size:.65rem;color:#3f3f46;margin:.4rem 0}

  /* Card list */
  .card-list{display:flex;flex-direction:column;gap:.4rem}
  .card-entry{display:flex;align-items:center;justify-content:space-between;background:#0a0a0f;border-radius:6px;padding:.5rem .65rem;font-size:.75rem}
  .ce-info{flex:1}
  .ce-name{font-weight:600;color:#fafafa}
  .ce-set{font-size:.6rem;color:#52525b}
  .ce-price{font-weight:700;color:#22c55e;margin:0 .75rem;min-width:60px;text-align:right}
  .ce-remove{color:#52525b;cursor:pointer;font-size:.7rem;padding:.2rem .4rem;border-radius:4px}
  .ce-remove:hover{color:#ef4444;background:rgba(239,68,68,.1)}

  /* VS divider */
  .vs-divider{display:flex;align-items:center;justify-content:center;transform:translateY(120px)}
  .vs-badge{background:#27272a;border:2px solid #3f3f46;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.9rem;color:#71717a}

  /* Analyze button */
  .analyze-btn{display:block;width:100%;max-width:400px;margin:0 auto 1.5rem;padding:.75rem;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none;border-radius:10px;color:#fff;font-size:1rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s}
  .analyze-btn:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(59,130,246,.3)}
  .analyze-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}

  /* Results */
  .results{display:none;margin-bottom:2rem}
  .results.show{display:block}
  .result-card{background:#18181b;border:1px solid #27272a;border-radius:14px;padding:1.5rem;text-align:center}
  .verdict{font-size:2.5rem;font-weight:900;margin-bottom:.25rem}
  .verdict-label{font-size:1.2rem;font-weight:700;margin-bottom:.75rem}
  .verdict-sub{font-size:.85rem;color:#a1a1aa;margin-bottom:1.25rem;line-height:1.5}
  .result-bars{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
  .result-bar{background:#0a0a0f;border-radius:10px;padding:1rem;text-align:center}
  .rb-label{font-size:.7rem;color:#71717a;text-transform:uppercase;letter-spacing:.05em}
  .rb-value{font-size:1.5rem;font-weight:800;margin-top:.25rem}
  .rb-detail{font-size:.7rem;color:#52525b;margin-top:.25rem}
  .advantage{background:#0a0a0f;border-radius:10px;padding:1rem;margin-top:1rem}
  .adv-title{font-size:.75rem;color:#71717a;text-transform:uppercase;margin-bottom:.5rem}
  .adv-bar-track{height:30px;background:#1a1a1f;border-radius:8px;overflow:hidden;display:flex;margin-bottom:.5rem}
  .adv-bar-a{background:linear-gradient(90deg,#3b82f6,#2563eb);height:100%;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;transition:width .8s ease}
  .adv-bar-b{background:linear-gradient(90deg,#f97316,#ea580c);height:100%;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:#fff;transition:width .8s ease}
  .adv-labels{display:flex;justify-content:space-between;font-size:.7rem;color:#71717a}

  .card-breakdown{margin-top:1rem;text-align:left}
  .cb-title{font-size:.75rem;color:#71717a;text-transform:uppercase;margin-bottom:.5rem}
  .cb-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
  .cb-side{background:#0a0a0f;border-radius:8px;padding:.75rem}
  .cb-side-title{font-size:.7rem;font-weight:700;margin-bottom:.4rem}
  .cb-item{display:flex;justify-content:space-between;font-size:.7rem;padding:.2rem 0;border-bottom:1px solid #18181b}
  .cb-item:last-child{border:none}

  footer{text-align:center;padding:1.5rem;color:#3f3f46;font-size:.65rem;border-top:1px solid #18181b;margin-top:2rem}
  footer a{color:#3b82f6;text-decoration:none}

  .settings-bar{text-align:center;margin-bottom:1.5rem}
  .settings-toggle{display:inline-block;font-size:.75rem;color:#71717a;cursor:pointer;padding:.3rem .8rem;border:1px solid #27272a;border-radius:999px;transition:all .2s}
  .settings-toggle:hover{border-color:#3f3f46;color:#e4e4e7}
  .settings-panel{max-width:500px;margin:.75rem auto 0;background:#18181b;border:1px solid #27272a;border-radius:10px;padding:1rem;text-align:left}
  .settings-label{font-size:.75rem;color:#a1a1aa;display:block;margin-bottom:.4rem}
  .settings-status{font-size:.7rem;margin-top:.4rem}
  .scan-btn{display:block;width:100%;margin-top:.5rem;padding:.5rem;background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;border-radius:8px;color:#fff;font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s}
  .scan-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 2px 12px rgba(139,92,246,.3)}
  .scan-btn:disabled{opacity:.5;cursor:not-allowed}
  .scan-status{font-size:.7rem;color:#a1a1aa;text-align:center;margin-top:.4rem;min-height:1rem}

  .clear-side-btn{display:inline-block;font-size:.6rem;color:#52525b;cursor:pointer;padding:.15rem .5rem;border:1px solid #27272a;border-radius:4px;transition:all .15s;margin-left:.5rem}
  .clear-side-btn:hover{color:#ef4444;border-color:#ef4444;background:rgba(239,68,68,.08)}
  .grade-select{background:#0a0a0f;border:1px solid #27272a;border-radius:6px;padding:.4rem .5rem;color:#e4e4e7;font-size:.7rem;font-family:inherit;outline:none;max-width:100px;cursor:pointer}
  .grade-select:focus{border-color:#3f3f46}
  .ce-grade{font-size:.6rem;color:#a78bfa;font-weight:600;margin-left:.3rem}
  .grade-badge{display:inline-block;font-size:.55rem;padding:.1rem .35rem;border-radius:3px;font-weight:700;margin-left:.3rem}
  .grade-badge.psa{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.25)}
  .grade-badge.bgs{background:rgba(59,130,246,.15);color:#3b82f6;border:1px solid rgba(59,130,246,.25)}
  .grade-badge.cgc{background:rgba(34,197,94,.15);color:#22c55e;border:1px solid rgba(34,197,94,.25)}
  .grade-badge.raw{background:rgba(113,113,122,.15);color:#71717a;border:1px solid rgba(113,113,122,.25)}


  .grade-picker{display:flex;flex-wrap:wrap;gap:.3rem;justify-content:center;margin-top:.5rem}
  .gp-btn{padding:.3rem .5rem;border-radius:6px;border:1px solid #27272a;background:#0a0a0f;color:#a1a1aa;font-size:.6rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .15s;text-align:center;min-width:55px}
  .gp-btn:hover{border-color:#8b5cf6;color:#e4e4e7}
  .gp-btn.active{border-color:#8b5cf6;color:#fff;background:rgba(139,92,246,.2)}
  .gp-btn.psa:hover,.gp-btn.psa.active{border-color:#ef4444;background:rgba(239,68,68,.15);color:#fca5a5}
  .gp-btn.bgs:hover,.gp-btn.bgs.active{border-color:#3b82f6;background:rgba(59,130,246,.15);color:#93c5fd}
  .gp-btn.cgc:hover,.gp-btn.cgc.active{border-color:#22c55e;background:rgba(34,197,94,.15);color:#86efac}
  @keyframes spin{to{transform:rotate(360deg)}}
  .spinner{display:inline-block;width:12px;height:12px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:.3rem}

</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <a href="/cards/" class="back">‚Üê Back to Dashboard</a>
  <header>
    <h1>‚öñÔ∏è Trade Analyzer</h1>
    <p>Upload photos of both sides of a trade to see who's winning</p>
  </header>

  
  <div class="settings-bar">
    <div style="font-size:.75rem;color:#71717a;margin-bottom:.25rem">üì∏ Upload card photos ‚Üí AI scans text ‚Üí Matches against price database</div>
    <div style="display:flex;gap:.5rem;justify-content:center;align-items:center;flex-wrap:wrap">
      <span style="font-size:.65rem;padding:.2rem .6rem;border-radius:999px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);color:#22c55e">‚ú® 100% Free</span>
      <span style="font-size:.65rem;padding:.2rem .6rem;border-radius:999px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);color:#3b82f6">üîí Runs in browser</span>
      <span style="font-size:.65rem;padding:.2rem .6rem;border-radius:999px;background:rgba(234,179,8,.1);border:1px solid rgba(234,179,8,.2);color:#eab308">üöÄ No setup needed</span>
    </div>
  </div>

  <div class="trade-area">
    <!-- Side A -->
    <div class="side side-a">
      <div class="side-header">
        <span class="side-title">üÖ∞Ô∏è Person A</span>
        <div><span class="side-total" id="totalA">$0.00</span><span class="clear-side-btn" onclick="clearSide('A')">‚úï Clear</span></div>
      </div>
      <div class="upload-zone" id="uploadA" onclick="document.getElementById('fileA').click()">
        <input type="file" id="fileA" multiple accept="image/*">
        <div class="upload-icon">üì∏</div>
        <div class="upload-text">Upload photos of Person A's cards</div>
        <div class="upload-sub">Click or drag ¬∑ Multiple photos OK</div>
      </div>
      <button class="scan-btn" id="scanBtnA" onclick="scanCards('A')" disabled>ü§ñ Scan Photos with AI</button>
      <div class="scan-status" id="scanStatusA"></div>
      <div class="add-card-area">
        <input type="text" class="card-search" id="searchA" placeholder="üîç Search card database to add..." autocomplete="off">
        <div class="search-results" id="resultsA"></div>
        <div class="or-divider">‚Äî or add custom ‚Äî</div>
        <div class="custom-add">
          <input type="text" id="customNameA" placeholder="Card name">
          <input type="text" id="customPriceA" placeholder="$ Value" style="max-width:80px">
          <select class="grade-select" id="customGradeA">
            <option value="raw">Raw</option>
            <option value="psa10">PSA 10</option>
            <option value="psa9">PSA 9</option>
            <option value="psa8">PSA 8</option>
            <option value="psa7">PSA 7</option>
            <option value="bgs10">BGS 10 Black</option>
            <option value="bgs95">BGS 9.5</option>
            <option value="bgs9">BGS 9</option>
            <option value="cgc10">CGC 10 Pristine</option>
            <option value="cgc95">CGC 9.5</option>
            <option value="cgc9">CGC 9</option>
          </select>
          <button onclick="addCustomCard('A')">Add</button>
        </div>
      </div>
      <div class="card-list" id="listA"></div>
    </div>

    <!-- VS -->
    <div class="vs-divider"><div class="vs-badge">VS</div></div>

    <!-- Side B -->
    <div class="side side-b">
      <div class="side-header">
        <span class="side-title">üÖ±Ô∏è Person B</span>
        <div><span class="side-total" id="totalB">$0.00</span><span class="clear-side-btn" onclick="clearSide('B')">‚úï Clear</span></div>
      </div>
      <div class="upload-zone" id="uploadB" onclick="document.getElementById('fileB').click()">
        <input type="file" id="fileB" multiple accept="image/*">
        <div class="upload-icon">üì∏</div>
        <div class="upload-text">Upload photos of Person B's cards</div>
        <div class="upload-sub">Click or drag ¬∑ Multiple photos OK</div>
      </div>
      <button class="scan-btn" id="scanBtnB" onclick="scanCards('B')" disabled>ü§ñ Scan Photos with AI</button>
      <div class="scan-status" id="scanStatusB"></div>
      <div class="add-card-area">
        <input type="text" class="card-search" id="searchB" placeholder="üîç Search card database to add..." autocomplete="off">
        <div class="search-results" id="resultsB"></div>
        <div class="or-divider">‚Äî or add custom ‚Äî</div>
        <div class="custom-add">
          <input type="text" id="customNameB" placeholder="Card name">
          <input type="text" id="customPriceB" placeholder="$ Value" style="max-width:80px">
          <select class="grade-select" id="customGradeB">
            <option value="raw">Raw</option>
            <option value="psa10">PSA 10</option>
            <option value="psa9">PSA 9</option>
            <option value="psa8">PSA 8</option>
            <option value="psa7">PSA 7</option>
            <option value="bgs10">BGS 10 Black</option>
            <option value="bgs95">BGS 9.5</option>
            <option value="bgs9">BGS 9</option>
            <option value="cgc10">CGC 10 Pristine</option>
            <option value="cgc95">CGC 9.5</option>
            <option value="cgc9">CGC 9</option>
          </select>
          <button onclick="addCustomCard('B')">Add</button>
        </div>
      </div>
      <div class="card-list" id="listB"></div>
    </div>
  </div>

  <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">‚öñÔ∏è Analyze Trade</button>

  <div class="results" id="results">
    <div class="result-card" id="resultCard"></div>
  </div>

  <footer>
    Prices from eBay sold listings ¬∑ Feb 2026 ¬∑ <a href="/cards/">Back to Investment Dashboard</a><br>
    Add cards from our database or enter custom values. Upload photos for visual reference.
  </footer>
</div>

<script>
// Card database with prices
const db=[
// Basketball
{name:"Cooper Flagg RC Auto",set:"2025-26 Topps Chrome",cat:"basketball",price:4250},
{name:"Victor Wembanyama Prizm Silver RC",set:"2023-24 Prizm PSA 10",cat:"basketball",price:1820},
{name:"Kon Knueppel Topps Chrome RC",set:"2025-26 Topps Chrome",cat:"basketball",price:85},
{name:"Michael Jordan 1986 Fleer RC",set:"1986-87 Fleer #57 PSA 8-9",cat:"basketball",price:42500},
{name:"Cooper Flagg Chrome Refractor",set:"2025-26 Topps Chrome #251",cat:"basketball",price:145},
{name:"Dylan Harper RC Auto",set:"2025-26 Topps Chrome",cat:"basketball",price:1150},
{name:"Anthony Edwards Prizm Silver RC",set:"2020-21 Prizm PSA 10",cat:"basketball",price:2450},
{name:"VJ Edgecombe Topps Chrome RC",set:"2025-26 Topps Chrome",cat:"basketball",price:75},
{name:"Kobe Bryant 1996 Topps RC",set:"1996-97 Topps #138",cat:"basketball",price:1850},
{name:"Shai Gilgeous-Alexander Prizm Silver",set:"2018-19 Prizm PSA 10",cat:"basketball",price:1200},
{name:"LeBron James Topps Chrome RC",set:"2003-04 Chrome #111 PSA 9+",cat:"basketball",price:68000},
{name:"Yang Hansen Chrome Advisory SSP",set:"2025-26 Topps Chrome",cat:"basketball",price:320},
{name:"Luka Doncic Prizm Silver RC",set:"2018-19 Prizm PSA 10",cat:"basketball",price:3800},
{name:"Stephen Curry Prizm Silver RC",set:"2012-13 Prizm PSA 10",cat:"basketball",price:8500},
{name:"Cooper Flagg Power Players Holo",set:"2025 Topps #PP-16",cat:"basketball",price:35},
{name:"Giannis Prizm Silver RC",set:"2013-14 Prizm PSA 10",cat:"basketball",price:4200},
{name:"Amen Thompson Prizm Silver RC",set:"2023-24 Prizm PSA 10",cat:"basketball",price:85},
{name:"Cooper Flagg Daydreamers",set:"2025 Topps Midnight",cat:"basketball",price:28},
{name:"Jaylen Brown Prizm Silver",set:"2016-17 Prizm PSA 10",cat:"basketball",price:450},
{name:"Wembanyama Topps Finest",set:"2025-26 Topps Finest",cat:"basketball",price:95},
// Football
{name:"Caleb Williams Prizm Silver RC",set:"2024 Prizm PSA 10",cat:"football",price:145},
{name:"Jayden Daniels Prizm Silver RC",set:"2024 Prizm PSA 10",cat:"football",price:185},
{name:"Brock Bowers Prizm Silver RC",set:"2024 Prizm PSA 10",cat:"football",price:95},
{name:"Shedeur Sanders Bowman Chrome Auto",set:"2024 Bowman Chrome",cat:"football",price:310},
{name:"Patrick Mahomes Prizm Silver RC",set:"2017 Prizm PSA 10",cat:"football",price:11500},
{name:"Quinn Ewers Rookies & Stars Auto",set:"2025 Rookies & Stars",cat:"football",price:65},
{name:"Jaxson Dart Mosaic Introductions",set:"2025 Mosaic",cat:"football",price:45},
{name:"Dillon Gabriel Mosaic Kaleidoscopic",set:"2025 Mosaic SSP",cat:"football",price:55},
{name:"Tom Brady 2000 Bowman RC",set:"2000 Bowman #236",cat:"football",price:2800},
{name:"Trevor Lawrence Mosaic NFL Debut",set:"2021 Mosaic",cat:"football",price:35},
{name:"Jerry Rice 1986 Topps RC",set:"1986 Topps #161",cat:"football",price:285},
{name:"Jalen Hurts Prizm Base RC",set:"2020 Prizm #343",cat:"football",price:125},
{name:"Bo Nix Prizm Silver RC",set:"2024 Prizm PSA 10",cat:"football",price:45},
{name:"Josh Allen Prizm Silver RC",set:"2018 Prizm PSA 10",cat:"football",price:5200},
{name:"Marvin Harrison Jr Prizm Silver RC",set:"2024 Prizm PSA 10",cat:"football",price:110},
{name:"Malik Nabers Prizm Silver RC",set:"2024 Prizm PSA 10",cat:"football",price:75},
{name:"Lamar Jackson Prizm Silver RC",set:"2018 Prizm PSA 10",cat:"football",price:1800},
{name:"Cam Ward Bowman Chrome Auto",set:"2024 Bowman Chrome",cat:"football",price:195},
{name:"Joe Burrow Prizm Silver RC",set:"2020 Prizm PSA 10",cat:"football",price:850},
{name:"Saquon Barkley Prizm Silver RC",set:"2018 Prizm PSA 10",cat:"football",price:185},
// Baseball
{name:"Paul Skenes Topps Chrome RC Auto",set:"2024 Chrome Update",cat:"baseball",price:525},
{name:"Nick Kurtz 2026 Topps Series 1 RC",set:"2026 Topps Series 1",cat:"baseball",price:45},
{name:"Shohei Ohtani Chrome Update RC",set:"2018 Chrome Update PSA 10",cat:"baseball",price:2450},
{name:"Konnor Griffin Bowman Draft Chrome",set:"2024 Bowman Draft 1st",cat:"baseball",price:42},
{name:"Roman Anthony 2026 Topps RC",set:"2026 Topps Series 1",cat:"baseball",price:18},
{name:"Shohei Ohtani 2018 Topps #700 RC",set:"2018 Topps Pitching",cat:"baseball",price:125},
{name:"Pete Crow-Armstrong Chrome RC",set:"2024 Chrome PSA 10",cat:"baseball",price:85},
{name:"Carlos Lagrange Bowman Chrome Auto",set:"2025 Bowman 1st Auto",cat:"baseball",price:180},
{name:"Shohei Ohtani Topps Update RC",set:"2018 Update #US1",cat:"baseball",price:85},
{name:"Jackson Holliday Bowman Chrome Auto",set:"2023 Bowman 1st Auto",cat:"baseball",price:350},
{name:"Shohei Ohtani 2018 Bowman RC",set:"2018 Bowman #49",cat:"baseball",price:65},
{name:"Mickey Mantle 1952 Topps",set:"1952 Topps #311 PSA 3-5",cat:"baseball",price:185000},
{name:"Elly De La Cruz Chrome RC",set:"2023 Chrome PSA 10",cat:"baseball",price:75},
{name:"Ohtani Chrome Update #HMT32",set:"2018 Chrome Update Debut",cat:"baseball",price:285},
{name:"Bobby Witt Jr Chrome RC",set:"2022 Chrome PSA 10",cat:"baseball",price:145},
{name:"Ken Griffey Jr 1989 Upper Deck RC",set:"1989 UD #1 PSA 9-10",cat:"baseball",price:3200},
{name:"Mike Trout 2011 Topps Update RC",set:"2011 Update PSA 10",cat:"baseball",price:2800},
{name:"Gunnar Henderson Chrome RC",set:"2023 Chrome PSA 10",cat:"baseball",price:95},
{name:"Junior Caminero Bowman Chrome Auto",set:"2023 Bowman 1st Auto",cat:"baseball",price:120},
{name:"Paul Skenes Bowman 1st Chrome Auto",set:"2022 Bowman Draft 1st",cat:"baseball",price:1800},
// Pokemon
{name:"Umbreon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 161/131",cat:"pokemon",price:1054,psa10:3200},
{name:"Charizard ex SAR (Prismatic Evo)",set:"Prismatic Evolutions",cat:"pokemon",price:285,psa10:850},
{name:"Pikachu ex SIR (Surging Sparks)",set:"Surging Sparks 238/191",cat:"pokemon",price:195,psa10:550},
{name:"Umbreon VMAX Alt Art",set:"Evolving Skies PSA 10",cat:"pokemon",price:3520},
{name:"Sylveon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 156/131",cat:"pokemon",price:309,psa10:900},
{name:"Leafeon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 144/131",cat:"pokemon",price:244,psa10:700},
{name:"Espeon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 155/131",cat:"pokemon",price:206,psa10:600},
{name:"1st Ed Shadowless Charizard Holo",set:"Base Set #4 PSA 7-8",cat:"pokemon",price:18500},
{name:"Glaceon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 150/131",cat:"pokemon",price:172,psa10:500},
{name:"Vaporeon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 149/131",cat:"pokemon",price:167,psa10:480},
{name:"Flareon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 146/131",cat:"pokemon",price:161,psa10:460},
{name:"Charizard ex SIR (Phantasmal Flames)",set:"Phantasmal Flames",cat:"pokemon",price:245,psa10:750},
{name:"Roaring Moon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 162/131",cat:"pokemon",price:153,psa10:440},
{name:"Jolteon ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 153/131",cat:"pokemon",price:143,psa10:420},
{name:"Eevee Heroes Umbreon V Alt Art",set:"Japanese Eevee Heroes PSA 10",cat:"pokemon",price:850},
{name:"Eevee ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 167/131",cat:"pokemon",price:117,psa10:350},
{name:"Ancient Mew Holo Promo",set:"Movie Promo",cat:"pokemon",price:65},
{name:"Mew ex SIR (151) ‚Äî Bubble Mew",set:"SV 151",cat:"pokemon",price:185},
{name:"Ceruledge ex SIR (Prismatic Evo)",set:"Prismatic Evolutions 147/131",cat:"pokemon",price:94,psa10:280},
{name:"Charizard ex SIR (Obsidian Flames)",set:"Obsidian Flames",cat:"pokemon",price:135,psa10:425}
];

const catIcons={basketball:'üèÄ',football:'üèà',baseball:'‚öæ',pokemon:'‚ö°'};

// Grading multipliers (relative to raw card value)
const gradeMultiByCat = {
  pokemon: {raw:1,psa10:4.75,psa9:2.2,psa8:1.4,psa7:1.0,bgs10:6.5,bgs95:3.0,bgs9:1.8,cgc10:5.0,cgc95:2.5,cgc9:1.6},
  basketball: {raw:1,psa10:3.0,psa9:1.7,psa8:1.15,psa7:0.85,bgs10:4.5,bgs95:2.2,bgs9:1.5,cgc10:3.5,cgc95:2.0,cgc9:1.4},
  football: {raw:1,psa10:3.0,psa9:1.7,psa8:1.15,psa7:0.85,bgs10:4.5,bgs95:2.2,bgs9:1.5,cgc10:3.5,cgc95:2.0,cgc9:1.4},
  baseball: {raw:1,psa10:3.2,psa9:1.8,psa8:1.2,psa7:0.9,bgs10:4.5,bgs95:2.3,bgs9:1.5,cgc10:3.8,cgc95:2.1,cgc9:1.4},
  custom: {raw:1,psa10:3.5,psa9:1.8,psa8:1.2,psa7:0.9,bgs10:5.0,bgs95:2.5,bgs9:1.6,cgc10:4.0,cgc95:2.2,cgc9:1.5}
};
function getGradeMulti(cat,grade){return (gradeMultiByCat[cat]||gradeMultiByCat.custom)[grade]||1;}
const gradeMultipliers = gradeMultiByCat.custom;

const gradeLabels = {
  raw: 'Raw', psa10: 'PSA 10', psa9: 'PSA 9', psa8: 'PSA 8', psa7: 'PSA 7',
  bgs10: 'BGS 10 BL', bgs95: 'BGS 9.5', bgs9: 'BGS 9',
  cgc10: 'CGC 10 P', cgc95: 'CGC 9.5', cgc9: 'CGC 9'
};

function gradeClass(g) {
  if (g.startsWith('psa')) return 'psa';
  if (g.startsWith('bgs')) return 'bgs';
  if (g.startsWith('cgc')) return 'cgc';
  return 'raw';
}

function clearSide(side) {
  sideCards[side] = [];
  uploadedFiles[side] = [];
  renderList(side);
  // Clear images too
  const zone = document.getElementById('upload'+side);
  zone.classList.remove('has-images');
  zone.innerHTML = '<input type="file" id="file'+side+'" multiple accept="image/*">' +
    '<div class="upload-icon">üì∏</div>' +
    '<div class="upload-text">Upload photos of Person '+side+'\'s cards</div>' +
    '<div class="upload-sub">Click or drag ¬∑ Multiple photos OK</div>';
  document.getElementById('file'+side).addEventListener('change',function(){handleFiles(this.files,side)});
  document.getElementById('scanStatus'+side).textContent = '';
  updateScanButtons();
  // Hide results if showing
  document.getElementById('results').classList.remove('show');
}
const sideCards={A:[],B:[]};

// Image upload handling
['A','B'].forEach(side=>{
  const fileInput=document.getElementById('file'+side);
  const zone=document.getElementById('upload'+side);

  zone.addEventListener('dragover',e=>{e.preventDefault();zone.style.borderColor='#3f3f46'});
  zone.addEventListener('dragleave',()=>{zone.style.borderColor='#27272a'});
  zone.addEventListener('drop',e=>{
    e.preventDefault();zone.style.borderColor='#27272a';
    handleFiles(e.dataTransfer.files,side);
  });
  fileInput.addEventListener('change',()=>handleFiles(fileInput.files,side));
});

function handleFiles(files,side){
  const zone=document.getElementById('upload'+side);
  zone.classList.add('has-images');
  let html='<div class="preview-grid">';
  Array.from(files).forEach(f=>{
    const url=URL.createObjectURL(f);
    html+=`<img src="${url}" class="preview-img">`;
  });
  html+=`</div><div class="clear-imgs" onclick="clearImages('${side}',event)">‚úï Clear photos</div>`;
  zone.innerHTML=`<input type="file" id="file${side}" multiple accept="image/*">${html}`;
  // Re-attach listener
  document.getElementById('file'+side).addEventListener('change',function(){handleFiles(this.files,side)});
}

function clearImages(side,e){
  e.stopPropagation();
  const zone=document.getElementById('upload'+side);
  zone.classList.remove('has-images');
  zone.innerHTML=`<input type="file" id="file${side}" multiple accept="image/*">
    <div class="upload-icon">üì∏</div>
    <div class="upload-text">Upload photos of Person ${side}'s cards</div>
    <div class="upload-sub">Click or drag ¬∑ Multiple photos OK</div>`;
  document.getElementById('file'+side).addEventListener('change',function(){handleFiles(this.files,side)});
}

// Search
['A','B'].forEach(side=>{
  const input=document.getElementById('search'+side);
  const results=document.getElementById('results'+side);

  input.addEventListener('input',()=>{
    const q=input.value.toLowerCase().trim();
    if(q.length<2){results.classList.remove('open');return}
    const matches=db.filter(c=>c.name.toLowerCase().includes(q)||c.set.toLowerCase().includes(q)||c.cat.includes(q)).slice(0,8);
    if(!matches.length){results.classList.remove('open');return}
    results.innerHTML=matches.map((c,i)=>`<div class="sr-item" onclick="addCard('${side}',${i},'${q}')">
      <span class="sr-name">${catIcons[c.cat]} ${c.name}<span class="sr-cat">${c.set}</span></span>
      <span class="sr-price">$${c.price.toLocaleString()}</span>
    </div>`).join('');
    results.classList.add('open');
    // store matches for reference
    results._matches=matches;
  });

  input.addEventListener('blur',()=>setTimeout(()=>results.classList.remove('open'),200));
});

function addCard(side,idx,q){
  const results=document.getElementById('results'+side);
  const card=results._matches[idx];
  // Check if scanner already detected a grade
  let gradeKey = window['_detectedGrade_' + side] || 'raw';
  let price = card.price;

  if (gradeKey === 'raw') {
    // Ask if card is graded
    const grade = prompt('Is this card graded? Enter grade or leave blank for raw:\n\nPSA 10, PSA 9, PSA 8, BGS 10, BGS 9.5, CGC 10, CGC 9.5');
    if (grade) {
      const g = grade.toLowerCase().replace(/\s+/g,'').replace('.','');
      if (g.includes('psa10')||g.includes('10')) gradeKey='psa10';
      else if (g.includes('psa9')||g==='9') gradeKey='psa9';
      else if (g.includes('psa8')||g==='8') gradeKey='psa8';
      else if (g.includes('psa7')||g==='7') gradeKey='psa7';
      else if (g.includes('bgs10')||g.includes('black')) gradeKey='bgs10';
      else if (g.includes('bgs95')||g.includes('9.5')) gradeKey='bgs95';
      else if (g.includes('bgs9')) gradeKey='bgs9';
      else if (g.includes('cgc10')||g.includes('pristine')) gradeKey='cgc10';
      else if (g.includes('cgc95')) gradeKey='cgc95';
      else if (g.includes('cgc9')) gradeKey='cgc9';
    }
  }

  const setLower = card.set.toLowerCase();
  const alreadyGraded = setLower.includes('psa') || setLower.includes('bgs') || setLower.includes('cgc');
  if (!alreadyGraded && gradeKey !== 'raw') {
    price = Math.round(card.price * getGradeMulti(card.cat, gradeKey));
  }

  sideCards[side].push({name:card.name, set:card.set, price, cat:card.cat, grade:gradeKey});
  document.getElementById('search'+side).value='';
  results.classList.remove('open');
  // Clear detected grade after use
  window['_detectedGrade_' + side] = null;
  renderList(side);
}

function addCustomCard(side){
  const name=document.getElementById('customName'+side).value.trim();
  const price=parseFloat(document.getElementById('customPrice'+side).value.replace(/[$,]/g,''));
  const grade=document.getElementById('customGrade'+side).value;
  if(!name||isNaN(price)){return}
  const gradeMulti = getGradeMulti('custom', grade);
  const adjPrice = grade === 'raw' ? price : Math.round(price * gradeMulti);
  sideCards[side].push({name, set:'Custom', price:adjPrice, cat:'custom', grade});
  document.getElementById('customName'+side).value='';
  document.getElementById('customPrice'+side).value='';
  document.getElementById('customGrade'+side).value='raw';
  renderList(side);
}

function removeCard(side,idx){
  sideCards[side].splice(idx,1);
  renderList(side);
}

function renderList(side){
  const list=document.getElementById('list'+side);
  const total=sideCards[side].reduce((s,c)=>s+c.price,0);
  document.getElementById('total'+side).textContent='$'+total.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  list.innerHTML=sideCards[side].map((c,i)=>{
    const icon = c.cat!=='custom' ? catIcons[c.cat]+' ' : '';
    const gb = c.grade && c.grade !== 'raw' ? '<span class="grade-badge '+gradeClass(c.grade)+'">'+gradeLabels[c.grade]+'</span>' : '';
    return `<div class="card-entry">
      <div class="ce-info">
        <div class="ce-name">${icon}${c.name}${gb}</div>
        <div class="ce-set">${c.set}</div>
      </div>
      <span class="ce-price">$${c.price.toLocaleString()}</span>
      <span class="ce-remove" onclick="removeCard('${side}',${i})">‚úï</span>
    </div>`;
  }).join('');
}

function analyze(){
  if(!sideCards.A.length||!sideCards.B.length){alert('Add cards to both sides first!');return}

  const totalA=sideCards.A.reduce((s,c)=>s+c.price,0);
  const totalB=sideCards.B.reduce((s,c)=>s+c.price,0);
  const diff=Math.abs(totalA-totalB);
  const pctDiff=((diff/Math.min(totalA,totalB))*100);
  const winner=totalA>totalB?'B':'A';
  const loser=winner==='A'?'B':'A';
  const winnerTotal=winner==='A'?totalA:totalB;
  const loserTotal=loser==='A'?totalA:totalB;
  const roi=((winnerTotal-loserTotal)/loserTotal*100);
  const pctA=(totalA/(totalA+totalB)*100);
  const pctB=(totalB/(totalA+totalB)*100);

  let verdict,verdictLabel,verdictColor,verdictSub;
  if(pctDiff<=5){
    verdict='‚úÖ';verdictLabel='FAIR TRADE';verdictColor='#22c55e';
    verdictSub=`Both sides are within 5% of each other. This is about as even as trades get. Total difference: $${diff.toLocaleString()} (${pctDiff.toFixed(1)}%).`;
  } else if(pctDiff<=15){
    verdict='‚ö†Ô∏è';verdictLabel='SLIGHT EDGE';verdictColor='#eab308';
    verdictSub=`Person ${winner} has a slight advantage, gaining ~${roi.toFixed(1)}% more value. Difference: $${diff.toLocaleString()}. Close enough that condition/grading could swing it.`;
  } else if(pctDiff<=40){
    verdict='üî∂';verdictLabel='UNEVEN TRADE';verdictColor='#f97316';
    verdictSub=`Person ${winner} is clearly winning this trade with a ${roi.toFixed(1)}% ROI advantage. They're getting $${diff.toLocaleString()} more in value. Person ${loser} should reconsider.`;
  } else {
    verdict='üö®';verdictLabel='LOPSIDED ‚Äî ROBBERY';verdictColor='#ef4444';
    verdictSub=`Person ${winner} is making out like a bandit ‚Äî ${roi.toFixed(0)}% more value ($${diff.toLocaleString()} difference). Person ${loser} is getting fleeced. Do NOT accept this trade.`;
  }

  const cardBreakdownA=sideCards.A.map(c=>`<div class="cb-item"><span>${c.name}</span><span style="color:#22c55e">$${c.price.toLocaleString()}</span></div>`).join('');
  const cardBreakdownB=sideCards.B.map(c=>`<div class="cb-item"><span>${c.name}</span><span style="color:#22c55e">$${c.price.toLocaleString()}</span></div>`).join('');

  document.getElementById('resultCard').innerHTML=`
    <div class="verdict" style="color:${verdictColor}">${verdict}</div>
    <div class="verdict-label" style="color:${verdictColor}">${verdictLabel}</div>
    <div class="verdict-sub">${verdictSub}</div>
    <div class="result-bars">
      <div class="result-bar" style="border:1px solid ${totalA>=totalB?'#3b82f6':'#27272a'}">
        <div class="rb-label">üÖ∞Ô∏è Person A's Value</div>
        <div class="rb-value" style="color:#3b82f6">$${totalA.toLocaleString()}</div>
        <div class="rb-detail">${sideCards.A.length} card${sideCards.A.length>1?'s':''}</div>
      </div>
      <div class="result-bar" style="border:1px solid ${totalB>=totalA?'#f97316':'#27272a'}">
        <div class="rb-label">üÖ±Ô∏è Person B's Value</div>
        <div class="rb-value" style="color:#f97316">$${totalB.toLocaleString()}</div>
        <div class="rb-detail">${sideCards.B.length} card${sideCards.B.length>1?'s':''}</div>
      </div>
    </div>
    <div class="advantage">
      <div class="adv-title">Value Distribution</div>
      <div class="adv-bar-track">
        <div class="adv-bar-a" style="width:${pctA}%">${pctA>=15?'A: '+pctA.toFixed(0)+'%':''}</div>
        <div class="adv-bar-b" style="width:${pctB}%">${pctB>=15?'B: '+pctB.toFixed(0)+'%':''}</div>
      </div>
      <div class="adv-labels"><span>Person A</span><span>${pctDiff<=5?'‚âà Even':'Person '+winner+' wins by $'+diff.toLocaleString()+' (+'+roi.toFixed(1)+'% ROI)'}</span><span>Person B</span></div>
    </div>
    <div class="card-breakdown">
      <div class="cb-title">Card-by-Card Breakdown</div>
      <div class="cb-grid">
        <div class="cb-side"><div class="cb-side-title" style="color:#3b82f6">üÖ∞Ô∏è Person A ‚Äî $${totalA.toLocaleString()}</div>${cardBreakdownA}</div>
        <div class="cb-side"><div class="cb-side-title" style="color:#f97316">üÖ±Ô∏è Person B ‚Äî $${totalB.toLocaleString()}</div>${cardBreakdownB}</div>
      </div>
    </div>`;

  document.getElementById('results').classList.add('show');
  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}

// Enter key for custom add
['A','B'].forEach(s=>{
  document.getElementById('customPrice'+s).addEventListener('keydown',e=>{if(e.key==='Enter')addCustomCard(s)});
});

// ===== CARD SCANNING (OCR + Smart Matching) =====
const uploadedFiles = {A: [], B: []};

const origHandleFiles = handleFiles;
handleFiles = function(files, side) {
  uploadedFiles[side] = Array.from(files);
  origHandleFiles(files, side);
  updateScanButtons();
};
const origClearImages = clearImages;
clearImages = function(side, e) {
  uploadedFiles[side] = [];
  origClearImages(side, e);
  updateScanButtons();
};
function updateScanButtons() {
  ['A','B'].forEach(s => {
    const btn = document.getElementById('scanBtn'+s);
    btn.disabled = !uploadedFiles[s].length;
    const st = document.getElementById('scanStatus'+s);
    // Don't overwrite scan results (they contain grade picker HTML)
    if (st.querySelector && st.querySelector('.grade-picker, .gp-btn, a[target]')) return;
    if (st.innerHTML && (st.innerHTML.includes('grade-picker') || st.innerHTML.includes('Cert #') || st.innerHTML.includes('Found'))) return;
    if (uploadedFiles[s].length) {
      st.textContent = '\u{1F4F8} ' + uploadedFiles[s].length + ' photo(s) ready';
      st.style.color = '#a1a1aa';
    } else { st.textContent = ''; }
  });
}
updateScanButtons();

// Card number ‚Üí DB index for precise slab matching
const cardNumberMap = {};
db.forEach((card, i) => {
  // Extract card numbers like "161/131", "#57", "#311", "#1", "238/191" etc
  const nums = card.set.match(/\d+\/\d+|#\d+/g);
  if (nums) nums.forEach(n => { cardNumberMap[n.replace('#','')] = i; });
});

// Unique name keywords that can match a single card by themselves
const uniqueNames = {
  'umbreon': null, 'charizard': null, 'pikachu': null, 'sylveon': null,
  'espeon': null, 'leafeon': null, 'glaceon': null, 'vaporeon': null,
  'flareon': null, 'jolteon': null, 'eevee': null, 'ceruledge': null, 'mewtwo': null,
  'flagg': null, 'wembanyama': null, 'wemby': null, 'mahomes': null,
  'ohtani': null, 'mantle': null, 'griffey': null, 'skenes': null
};
// Map unique names to their DB indices
db.forEach((card, i) => {
  const nameLower = card.name.toLowerCase();
  Object.keys(uniqueNames).forEach(uname => {
    if (nameLower.includes(uname)) {
      if (uniqueNames[uname] === null) uniqueNames[uname] = [i];
      else uniqueNames[uname].push(i);
    }
  });
});

function detectGrade(text) {
  const t = text.toLowerCase().replace(/[^a-z0-9.\s]/g, ' ');
  // PSA grades
  if (/psa\s*(?:gem\s*(?:mt|mint))?\s*10/i.test(t) || /gem\s*(?:mt|mint)\s*10/i.test(t)) return 'psa10';
  if (/psa\s*(?:mint)?\s*9(?:\s|$)/i.test(t)) return 'psa9';
  if (/psa\s*(?:nm.?mt)?\s*8/i.test(t)) return 'psa8';
  if (/psa\s*(?:nm)?\s*7/i.test(t)) return 'psa7';
  // BGS grades
  if (/b(?:gs|eckett)\s*(?:pristine|black)?\s*10/i.test(t)) return 'bgs10';
  if (/b(?:gs|eckett)\s*(?:gem\s*mint)?\s*9[\s.]5/i.test(t)) return 'bgs95';
  if (/b(?:gs|eckett)\s*(?:mint)?\s*9(?:\s|$)/i.test(t)) return 'bgs9';
  // CGC grades
  if (/cgc\s*(?:pristine)?\s*10/i.test(t)) return 'cgc10';
  if (/cgc\s*(?:gem)?\s*9[\s.]5/i.test(t)) return 'cgc95';
  if (/cgc\s*(?:mint)?\s*9(?:\s|$)/i.test(t)) return 'cgc9';
  // Common OCR misreads of PSA
  if (/(p[s5][a4]|ps[a@])\s*10/i.test(t)) return 'psa10';
  if (/(gem\s*m[ti1]n?t?\s*10)/i.test(t)) return 'psa10';
  return 'raw';
}

// Preprocess image for better OCR
function preprocessImage(file) {
  return new Promise(resolve => {
    const timeout = setTimeout(() => { console.warn('Preprocess timeout'); resolve(file); }, 8000);
    try {
      const img = new Image();
      img.onerror = () => { clearTimeout(timeout); resolve(file); };
      img.onload = () => {
        try {
          const canvas = document.createElement('canvas');
          const scale = Math.min(2000/img.width, 2000/img.height, 2);
          canvas.width = Math.max(1, Math.round(img.width*scale));
          canvas.height = Math.max(1, Math.round(img.height*scale));
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const d = imageData.data;
          for (let i = 0; i < d.length; i += 4) {
            const gray = 0.299*d[i] + 0.587*d[i+1] + 0.114*d[i+2];
            const v = Math.max(0, Math.min(255, ((gray-128)*1.5)+128));
            d[i]=d[i+1]=d[i+2]=v;
          }
          ctx.putImageData(imageData, 0, 0);
          canvas.toBlob(blob => { clearTimeout(timeout); resolve(blob||file); }, 'image/png');
        } catch(e) { clearTimeout(timeout); resolve(file); }
      };
      img.src = URL.createObjectURL(file);
    } catch(e) { clearTimeout(timeout); resolve(file); }
  });
}

function smartMatch(ocrText) {
  const text = ocrText.toLowerCase().replace(/[^a-z0-9/.\s]/g, ' ');
  const results = [];
  const added = new Set();

  // Identity words ‚Äî a match MUST include at least one of these to count
  // These are player/character names that actually identify a specific card
  const identityWords = new Set([
    'umbreon','charizard','pikachu','sylveon','espeon','leafeon','glaceon',
    'vaporeon','flareon','jolteon','eevee','ceruledge','mewtwo','mew',
    'flagg','wembanyama','wemby','knueppel','harper','edgecombe','hansen',
    'jordan','lebron','curry','luka','kobe','edwards','giannis','thompson','brown',
    'mahomes','allen','burrow','williams','daniels','bowers','sanders',
    'lawrence','hurts','brady','ewers','dart','gabriel','nix','nabers',
    'harrison','ward','barkley','jackson','rice',
    'ohtani','skenes','trout','griffey','mantle','witt','henderson',
    'anthony','kurtz','griffin','lagrange','holliday','caminero','armstrong','cruz'
  ]);

  // 1. Card number matching (most precise for slabs)
  const numberPatterns = text.match(/\d{1,3}\s*[/]\s*\d{1,3}/g) || [];
  numberPatterns.forEach(pat => {
    const clean = pat.replace(/\s/g, '');
    if (cardNumberMap[clean] !== undefined) {
      const idx = cardNumberMap[clean];
      if (!added.has(idx)) { results.push({card: db[idx], confidence: 'high'}); added.add(idx); }
    }
  });

  // 2. Unique name matching (single keyword enough)
  Object.entries(uniqueNames).forEach(([name, indices]) => {
    if (indices && text.includes(name)) {
      // If multiple cards match this name, try to narrow down with context words
      const best = indices.length === 1 ? indices :
        indices.filter(i => {
          const card = db[i];
          const cardWords = (card.name + ' ' + card.set).toLowerCase().split(/\s+/);
          return cardWords.filter(w => w.length > 3 && text.includes(w)).length >= 2;
        });
      const pick = best.length ? best : [indices[0]];
      pick.forEach(idx => {
        if (!added.has(idx)) { results.push({card: db[idx], confidence: 'medium'}); added.add(idx); }
      });
    }
  });

  // 3. Strict fuzzy match ‚Äî REQUIRES an identity word match
  // Generic words like "chrome", "topps", "2025" alone won't trigger a match
  const words = text.split(/\s+/).filter(w => w.length >= 3);
  const ocrHasIdentity = words.filter(w => identityWords.has(w));

  if (ocrHasIdentity.length > 0) {
    db.forEach((card, idx) => {
      if (added.has(idx)) return;
      const cardNameLower = card.name.toLowerCase();
      // Card name must contain at least one of the identity words found in OCR
      const nameMatch = ocrHasIdentity.some(w => cardNameLower.includes(w));
      if (!nameMatch) return;
      // Also need at least one more supporting word from set/name
      const ct = (card.name + ' ' + card.set).toLowerCase();
      const supporting = words.filter(w => !identityWords.has(w) && w.length > 3 && ct.includes(w));
      if (supporting.length >= 1) {
        results.push({card: db[idx], confidence: 'low'});
        added.add(idx);
      }
    });
  }

  return results;
}

async function scanCards(side) {
  const files = uploadedFiles[side];
  if (!files.length) return;

  const btn = document.getElementById('scanBtn'+side);
  const st = document.getElementById('scanStatus'+side);
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Scanning...';

  try {
    let allText = '';
    for (let i = 0; i < files.length; i++) {
      st.textContent = '\u{1F50D} Preprocessing photo ' + (i+1) + '/' + files.length + '...';
      st.style.color = '#8b5cf6';
      const processed = await preprocessImage(files[i]);

      st.textContent = '\u{1F50D} Scanning photo ' + (i+1) + '/' + files.length + '...';
      const r = await Tesseract.recognize(processed, 'eng', {
        logger: m => {
          if (m.status === 'recognizing text') {
            st.textContent = '\u{1F50D} Photo ' + (i+1) + '/' + files.length + ': ' + Math.round((m.progress||0)*100) + '%';
          }
        }
      });
      allText += ' ' + r.data.text;
    }

    console.log('[CardScan OCR text]:', allText);

    // Detect PSA cert number (8-10 digit number, usually the largest number on the slab)
    const certMatches = allText.match(/\b(\d{8,10})\b/g);
    let certNumber = null;
    if (certMatches) {
      // Filter out years and common non-cert numbers; cert numbers are typically 8+ digits
      certNumber = certMatches.find(n => n.length >= 8 && !n.startsWith('2025') && !n.startsWith('2024') && !n.startsWith('2023'));
    }
    console.log('[CardScan cert]:', certNumber);

    st.textContent = '\u{1F9E0} Matching against database...';
    const grade = detectGrade(allText);
    const matches = smartMatch(allText);

    if (matches.length) {
      // Show grade picker for each matched card
      window['_pendingMatches_' + side] = matches.slice(0, 10);
      const ocrGrade = grade;

      let html2 = '<div style="margin-top:.5rem">';
      matches.slice(0, 10).forEach((m, i) => {
        const icon = catIcons[m.card.cat] || '';
        const setLower = m.card.set.toLowerCase();
        const alreadyGraded = setLower.includes('psa') || setLower.includes('bgs') || setLower.includes('cgc');
        const basePrice = m.card.price;
        const cat = m.card.cat;

        html2 += '<div style="background:#0a0a0f;border-radius:8px;padding:.6rem;margin-bottom:.4rem">';
        html2 += '<div style="font-size:.8rem;font-weight:600;margin-bottom:.3rem">' + icon + ' ' + m.card.name + '</div>';
        html2 += '<div style="font-size:.65rem;color:#52525b;margin-bottom:.4rem">' + m.card.set + '</div>';
        html2 += '<div style="font-size:.65rem;color:#a1a1aa;margin-bottom:.3rem">Select condition:</div>';
        html2 += '<div class="grade-picker">';

        const grades = [
          {key:'raw',label:'Raw',cls:''},
          {key:'psa10',label:'PSA 10',cls:'psa'},
          {key:'psa9',label:'PSA 9',cls:'psa'},
          {key:'bgs10',label:'BGS 10 BL',cls:'bgs'},
          {key:'bgs95',label:'BGS 9.5',cls:'bgs'},
          {key:'cgc10',label:'CGC 10',cls:'cgc'},
          {key:'cgc95',label:'CGC 9.5',cls:'cgc'}
        ];

        grades.forEach(g => {
          const multi = (alreadyGraded || g.key === 'raw') ? 1 : getGradeMulti(cat, g.key);
          let price;
          if (g.key === 'raw') { price = basePrice; }
          else if (g.key === 'psa10' && m.card.psa10 && !alreadyGraded) { price = m.card.psa10; }
          else { price = Math.round(basePrice * multi); }
          const isOCR = (g.key === ocrGrade && ocrGrade !== 'raw');
          html2 += '<button class="gp-btn ' + g.cls + (isOCR ? ' active' : '') + '" '
            + 'onclick="addScanned(\'' + side + '\',' + i + ',\'' + g.key + '\')">'
            + g.label + '<br><b>$' + price.toLocaleString() + '</b></button>';
        });

        html2 += '</div></div>';
      });
      html2 += '</div>';

      // Add cert lookup link if detected
      let certHtml = '';
      if (certNumber) {
        const ebayUrl = 'https://www.ebay.com/sch/i.html?_nkw=PSA+' + certNumber + '&LH_Complete=1&LH_Sold=1&_sop=13';
        const psaUrl = 'https://www.psacard.com/cert/' + certNumber;
        certHtml = '<div style="margin-top:.5rem;padding:.5rem;background:rgba(139,92,246,.08);border:1px solid rgba(139,92,246,.2);border-radius:8px;text-align:center">'
          + '<div style="font-size:.7rem;color:#a78bfa;font-weight:600;margin-bottom:.3rem">\u{1F50E} Cert #' + certNumber + ' detected</div>'
          + '<div style="display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap">'
          + '<a href="' + ebayUrl + '" target="_blank" style="font-size:.65rem;padding:.25rem .6rem;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);border-radius:6px;color:#3b82f6;text-decoration:none">\u{1F4B0} Check eBay Sold Price</a>'
          + '<a href="' + psaUrl + '" target="_blank" style="font-size:.65rem;padding:.25rem .6rem;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);border-radius:6px;color:#ef4444;text-decoration:none">\u{1F3C6} Verify on PSA</a>'
          + '</div>'
          + '<div style="font-size:.6rem;color:#52525b;margin-top:.3rem">Find the exact sold price for this specific card</div>'
          + '</div>';
      }

      const gradeNote = ocrGrade !== 'raw'
        ? ' \u{1F3C6} Detected: <strong style="color:#a78bfa">' + gradeLabels[ocrGrade] + '</strong>'
        : '';
      st.innerHTML = '\u2705 Found ' + matches.length + ' card(s)!' + gradeNote
        + '<br><span style="color:#a1a1aa;font-size:.7rem">Tap a grade button to add with the correct value:</span>'
        + certHtml + html2;
      st.style.color = '#22c55e';
    } else {
      // Show what we detected + quick-pick buttons for common cards
      const clean = allText.replace(/[\n\r]+/g,' ').replace(/\s+/g,' ').trim().substring(0,200);
      let certHtml2 = '';
      if (certNumber) {
        const ebayUrl = 'https://www.ebay.com/sch/i.html?_nkw=PSA+' + certNumber + '&LH_Complete=1&LH_Sold=1&_sop=13';
        const psaUrl = 'https://www.psacard.com/cert/' + certNumber;
        certHtml2 = '<br><div style="margin-top:.4rem;display:flex;gap:.4rem;justify-content:center;flex-wrap:wrap">'
          + '<a href="' + ebayUrl + '" target="_blank" style="font-size:.65rem;padding:.25rem .6rem;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3);border-radius:6px;color:#3b82f6;text-decoration:none">\u{1F4B0} Check eBay Price for Cert #' + certNumber + '</a>'
          + '<a href="' + psaUrl + '" target="_blank" style="font-size:.65rem;padding:.25rem .6rem;background:rgba(239,68,68,.15);border:1px solid rgba(239,68,68,.3);border-radius:6px;color:#ef4444;text-decoration:none">\u{1F3C6} Verify on PSA</a>'
          + '</div>';
      }
      const gradeMsg = grade !== 'raw' ? '<br>\u{1F3C6} Grade detected: <strong style="color:#a78bfa">' + gradeLabels[grade] + '</strong>' : '';
      st.innerHTML = '\u26A0\uFE0F Couldn\'t auto-match from OCR text.' + gradeMsg +
        '<br><span style="color:#52525b">Text found: "' + (clean||'none') + '"</span>' +
        '<br><span style="color:#a1a1aa">Use the search below to find your card ‚Äî grade will be applied automatically.</span>';
      st.style.color = '#eab308';

      // Store detected grade so manual search picks it up
      window['_detectedGrade_' + side] = grade;
    }
  } catch(e) {
    console.error('Scan error:', e);
    st.textContent = '\u274C ' + (e.message || 'Scan failed. Try a clearer photo.');
    st.style.color = '#ef4444';
  }
  btn.innerHTML = '\u{1F916} Scan Photos with AI';
  btn.disabled = false;
  updateScanButtons();
}

function addScanned(side, idx, gradeKey) {
  const matches = window['_pendingMatches_' + side];
  if (!matches || !matches[idx]) return;
  const m = matches[idx];
  let price = m.card.price;
  const setLower = m.card.set.toLowerCase();
  const alreadyGraded = setLower.includes('psa') || setLower.includes('bgs') || setLower.includes('cgc');
  if (!alreadyGraded && gradeKey !== 'raw') {
    price = Math.round(price * getGradeMulti(m.card.cat, gradeKey));
  }
  // Update if already added, else add new
  const existing = sideCards[side].find(c => c.name === m.card.name);
  if (existing) {
    existing.grade = gradeKey;
    existing.price = price;
  } else {
    sideCards[side].push({name: m.card.name, set: m.card.set, price, cat: m.card.cat, grade: gradeKey});
  }
  renderList(side);
  // Highlight selected button
  const picker = document.getElementById ? null : null; // use event
  if (event && event.target) {
    const parent = event.target.closest('.grade-picker');
    if (parent) { parent.querySelectorAll('.gp-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); }
  }
}

</script>
</body>
</html>
